<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Đăng nhập</title>
    <!-- Performance: warm up critical third-party connections -->
    <link rel="dns-prefetch" href="//cdn.tailwindcss.com" />
    <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin />
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://identitytoolkit.googleapis.com" crossorigin />
    <link rel="preconnect" href="https://securetoken.googleapis.com" crossorigin />
    <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin />

    <!-- Preload local modules and styles to reduce waterfall -->
    <link rel="modulepreload" href="/js/firebase.js" />
    <link rel="modulepreload" href="/js/auth.js" />
    <link rel="modulepreload" href="/js/header.js" />
    <link rel="preload" as="style" href="/css/liquid.css" />
    <link rel="stylesheet" href="/css/liquid.css" />
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="apple text-gray-900 min-h-screen flex flex-col">
    <div id="siteHeader"></div>
    
    <main class="flex-grow flex items-center justify-center p-4">
      <div class="w-full max-w-md glass-card p-6">
        <h1 class="text-xl font-semibold text-center">Chào mừng quay lại</h1>
        <p class="text-sm text-gray-600 text-center mb-6">Đăng nhập để truy cập khoá học</p>

        <div class="space-y-4">
          <label class="block">
            <span class="text-sm">Email</span>
            <input id="email" type="email" class="mt-1 field" placeholder="ban@vidu.com" />
          </label>
          <label class="block">
            <span class="text-sm">Mật khẩu</span>
            <div class="relative">
              <input id="password" type="password" class="mt-1 field pr-10" placeholder="••••••••" />
              <button type="button" id="togglePwd" aria-label="Hiện/ẩn mật khẩu" class="absolute inset-y-0 right-0 flex items-center px-3 text-gray-500 hover:text-gray-700">
                <svg id="eyeOn" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7Z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
                <svg id="eyeOff" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden">
                  <path d="M3 3l18 18M10.58 10.58A3 3 0 0 0 12 15a3 3 0 0 0 2.42-4.42M9.88 5.09A10.94 10.94 0 0 1 12 5c7 0 11 7 11 7a18.37 18.37 0 0 1-5.17 5.11"/>
                  <path d="M6.61 6.61A18.5 18.5 0 0 0 1 12s4 7 11 7a10.9 10.9 0 0 0 4.38-.9"/>
                </svg>
              </button>
            </div>
          </label>
        </div>

        <div class="flex items-center justify-between mt-4">
          <button id="loginBtn" class="btn btn-primary">Đăng nhập</button>
          <span class="text-sm text-gray-400 px-2">Tài khoản do Admin cung cấp</span>
        </div>

        <button id="resetBtn" class="mt-3 text-sm text-blue-600">Quên mật khẩu?</button>

        <p id="msg" class="mt-4 text-sm"></p>
        <div class="mt-6 text-center">
          <a href="/" class="text-sm text-gray-600 hover:underline">Về trang chủ</a>
        </div>
      </div>
    </main>

    <script type="module">
      import { loginWithEmail, sendResetLink, currentUserProfile } from './js/auth.js';
      const email = document.getElementById('email');
      const password = document.getElementById('password');
      const msg = document.getElementById('msg');
      const togglePwd = document.getElementById('togglePwd');
      const eyeOn = document.getElementById('eyeOn');
      const eyeOff = document.getElementById('eyeOff');

      const show = (t, ok=false) => {
        msg.textContent = t;
        msg.className = `mt-4 text-sm ${ok ? 'text-green-600' : 'text-red-600'}`;
      };

      const explainAuthError = (e) => {
        const code = e?.code || '';
        switch (code) {
          case 'auth/invalid-email':
            return 'Email không hợp lệ.';
          case 'auth/missing-password':
            return 'Vui lòng nhập mật khẩu.';
          case 'auth/invalid-credential':
            return 'Email hoặc mật khẩu không đúng, hoặc tài khoản chưa tồn tại.';
          case 'auth/operation-not-allowed':
            return 'Đăng nhập bằng Email/Password chưa được bật trong Firebase Console.';
          case 'auth/user-disabled':
            return 'Tài khoản đã bị vô hiệu hoá.';
          case 'auth/too-many-requests':
            return 'Bạn đã thử quá nhiều lần. Vui lòng thử lại sau.';
          case 'auth/network-request-failed':
            return 'Lỗi mạng. Kiểm tra kết nối internet của bạn.';
          default:
            return e?.message || 'Đã xảy ra lỗi xác thực.';
        }
      };

      document.getElementById('loginBtn').onclick = async () => {
        msg.textContent = 'Đang đăng nhập...';
        try {
          await loginWithEmail(email.value, password.value);
          show('Đăng nhập thành công', true);
          const profile = await currentUserProfile();
          if (profile?.role === 'admin' && !profile?.disabled) {
            window.location.href = '/admin.html';
          } else {
            window.location.href = '/app.html#dashboard';
          }
        } catch (e) {
          console.error('Login error:', e);
          show(explainAuthError(e));
        }
      };

      // Toggle hiện/ẩn mật khẩu với icon hiện đại
      togglePwd?.addEventListener('click', () => {
        const isHidden = password.type === 'password';
        password.type = isHidden ? 'text' : 'password';
        eyeOn.classList.toggle('hidden', isHidden);
        eyeOff.classList.toggle('hidden', !isHidden);
        password.focus();
      });

      // Đã loại bỏ chức năng đăng ký tự phục vụ của user.

      document.getElementById('resetBtn').onclick = async () => {
        try {
          await sendResetLink(email.value);
          show('Đã gửi email đặt lại mật khẩu', true);
        } catch (e) {
          console.error('Reset error:', e);
          show(explainAuthError(e));
        }
      }
    </script>
    <script type="module" src="/js/header.js"></script>
  </body>
  </html>
