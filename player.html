<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Player</title>
    <!-- Performance: warm up critical third-party connections -->
    <link rel="dns-prefetch" href="//cdn.tailwindcss.com" />
    <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin />
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://identitytoolkit.googleapis.com" crossorigin />
    <link rel="preconnect" href="https://securetoken.googleapis.com" crossorigin />

    <!-- Preload local modules to reduce waterfall -->
    <link rel="modulepreload" href="./js/firebase.js" />
    <link rel="modulepreload" href="./js/auth.js" />
    <script>
      // Load local Tailwind if available (checks MIME to avoid console errors), else CDN fallback
      (async function(){
        function loadCdn(){
          var s=document.createElement('script');
          s.src='https://cdn.tailwindcss.com';
          document.head.appendChild(s);
          console.warn('Tailwind CDN loaded as fallback. Build Tailwind for production.');
        }
        try {
          const res = await fetch('./css/tailwind.css', { method:'HEAD', cache:'no-store' });
          const ct = (res.headers.get('content-type')||'').toLowerCase();
          if (res.ok && ct.includes('text/css')) {
            var l=document.createElement('link');
            l.rel='stylesheet';
            l.href='./css/tailwind.css';
            document.head.appendChild(l);
          } else {
            loadCdn();
          }
        } catch (e) { loadCdn(); }
      })();
    </script>
    <meta http-equiv="Referrer-Policy" content="no-referrer" />
    <style>
      html, body { height: 100%; margin: 0; background: #000; }
      .wrap { height: 100%; }
      /* Chặn menu chuột phải để hạn chế tải dễ dãi (không tuyệt đối) */
      body { -webkit-user-select: none; user-select: none; }
    </style>
  </head>
  <body>
    <div id="root" class="wrap">
      <div class="w-full h-full flex items-center justify-center text-white/80">Đang tải…</div>
    </div>
    <script type="module">
      import { requireAuth } from './js/auth.js';
      await requireAuth('./login.html');
  
      const p = new URLSearchParams(location.search);
      const b64 = p.get('embed') || '';
      const b64o = p.get('o') || '';
      let url = '';
      let originalUrl = '';
      try {
        url = atob(b64);
      } catch (e) {}
      try {
        originalUrl = atob(b64o);
      } catch (e) {}

      function isAllowed(u) {
        try {
          const x = new URL(u);
          if (x.hostname.endsWith('youtube.com') && x.pathname.startsWith('/embed/')) return true;
          if (x.hostname.endsWith('drive.google.com') && /\/file\/d\/.+\/preview/.test(x.pathname)) return true;
          return false;
        } catch (e) { return false; }
      }

      const root = document.getElementById('root');
      if (!url || !isAllowed(url)) {
        root.innerHTML = '<div class="w-full h-full flex items-center justify-center text-sm text-white/70">Link video không hợp lệ</div>';
      } else {
        const title = (new URLSearchParams(location.search).get('t') || '').toString();
        root.innerHTML = '';
        const container = document.createElement('div');
        container.className = 'w-full h-full';
        const bar = document.createElement('div');
        bar.className = 'flex items-center justify-between text-xs text-white/70 px-3 py-2 bg-black/40';
        const titleSpan = document.createElement('div');
        titleSpan.textContent = title || '';
        bar.appendChild(titleSpan);
        const actions = document.createElement('div');
        if (originalUrl) {
          const a = document.createElement('a');
          a.href = originalUrl;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.className = 'underline hover:no-underline text-white/80';
          a.textContent = 'Mở trong tab mới';
          actions.appendChild(a);
        }
        bar.appendChild(actions);
        container.appendChild(bar);
        const frameWrap = document.createElement('div');
        frameWrap.className = 'w-full h-[calc(100%-2rem)] md:h-[calc(100%-2.25rem)]';
        const iframe = document.createElement('iframe');
        iframe.className = 'w-full h-full';
        iframe.src = url;
        iframe.title = 'Video bài giảng';
        iframe.frameBorder = '0';
        iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
        iframe.referrerPolicy = 'no-referrer';
        // Hạn chế một số hành vi tải xuống (không tuyệt đối)
        iframe.sandbox = 'allow-scripts allow-same-origin allow-forms allow-presentation';
        frameWrap.appendChild(iframe);
        container.appendChild(frameWrap);
        root.appendChild(container);
        document.addEventListener('contextmenu', (e) => e.preventDefault());
      }
    </script>
  </body>
  </html>
