rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function isSelf(uid) { return isSignedIn() && request.auth.uid == uid; }
    function userDoc(uid) { return get(/databases/$(database)/documents/users/$(uid)); }
    function isAdmin() { return isSignedIn() && userDoc(request.auth.uid).data.role == 'admin'; }

    // Users collection
    match /users/{uid} {
      allow read: if isSelf(uid) || isAdmin();
      allow create: if isSelf(uid); // profile bootstrap on first login
      allow update: if isSelf(uid) || isAdmin();
      allow delete: if isAdmin();
    }

    // Per-course progress
    match /users/{uid}/progress/{courseId} {
      allow read, write: if isSelf(uid) || isAdmin();
    }

    // Courses: readable only by enrolled users or admins
    match /courses/{courseId} {
      allow read: if isAdmin() || (
        isSignedIn() && (courseId in (userDoc(request.auth.uid).data.enrolledCourseIds || []))
      );
      allow create, update, delete: if isAdmin();
    }
  }
}
